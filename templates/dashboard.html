{% extends "base.html" %}

{% block content %}
<style>
    /* Card Styling */
    .site-card {
        background-color: var(--color-surface);
        border: 1px solid var(--color-border);
        border-radius: 12px;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        position: relative; /* Keep for positioning context */
    }
    .site-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04), 0 0 40px rgba(88, 166, 255, 0.2);
        z-index: 10; /* <-- ADD THIS LINE */
    }
    .site-card:hover::before {
        content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: radial-gradient(circle at var(--mouse-x) var(--mouse-y), rgba(88, 166, 255, 0.1), transparent 40%);
        opacity: 1; transition: opacity 0.3s ease; pointer-events: none;
    }

    body.dropdown-active .site-card:hover {
        transform: none;
        box-shadow: none;
    }
    body.dropdown-active .site-card:hover::before {
        opacity: 0;
    }

    /* Modal Styling */
    .modal{display:none;position:fixed;z-index:1050;left:0;top:0;width:100%;height:100%;overflow-x:hidden;overflow-y:auto;background-color:rgba(0,0,0,.7);align-items:center;justify-content:center}.modal.show{display:flex}.modal-content{background-color:var(--color-surface);border:1px solid var(--color-border);border-radius:12px;box-shadow:0 20px 25px -5px rgba(0,0,0,.4);position:relative;display:flex;flex-direction:column;width:100%;max-width:500px;margin:1.75rem auto}.modal-header{display:flex;justify-content:space-between;align-items:center;padding:1rem 1.5rem;border-bottom:1px solid var(--color-border)}.modal-title{font-size:1.25rem;font-weight:600;color:var(--color-text-primary)}.btn-close{background:0 0;border:0;font-size:1.5rem;color:var(--color-text-secondary);cursor:pointer}.modal-body{position:relative;flex:1 1 auto;padding:1.5rem}.modal-footer{display:flex;justify-content:flex-end;align-items:center;padding:1rem 1.5rem;border-top:1px solid var(--color-border);gap:.5rem}.modal-sm .modal-content{max-width:380px}.modal-lg .modal-content{max-width:800px}
    .modal-header.bg-dark-danger { background-color: #3e2626; border-color: #6f4242; }

    /* Form & ANSI Log Styling */
    .form-input{background-color:#010409;border:1px solid var(--color-border);color:var(--color-text-primary);transition:border-color .3s ease,box-shadow .3s ease;width:100%;padding:.5rem .75rem;border-radius:6px}.form-input:focus{outline:0;border-color:var(--color-primary);box-shadow:0 0 0 3px rgba(88,166,255,.2)}
    .ansi-log-container{font-family:monospace;background-color:#010409;color:#ccc;max-height:500px;overflow-y:auto;white-space:pre-wrap;word-wrap:break-word;border:1px solid var(--color-border);padding:1rem;border-radius:.5rem}.ansi-black{color:#000}.ansi-red{color:#ff3333}.ansi-green{color:#66ff66}.ansi-yellow{color:#ffff66}.ansi-blue{color:#6666ff}.ansi-magenta{color:#ff66ff}.ansi-cyan{color:#66ffff}.ansi-white{color:#fff}.ansi-bold{font-weight:700}
</style>

<div class="flex items-center justify-between pb-4 mb-4 border-b border-gray-700">
    <h1 class="text-4xl font-bold gradient-text"><i class="bi bi-speedometer2 me-2"></i> Dashboard</h1>
    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#createSiteModal"> &nbsp;+&nbsp; </button>
</div>

<h2 class="text-2xl font-semibold text-white mb-6">My Websites</h2>

<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
    {% for site in sites %}
    <div class="site-card flex flex-col p-6">
        <h5 class="text-2xl font-bold text-white mb-2">{{ site.name }}</h5>
        <p class="text-gray-400 mb-2">Port: <span class="font-semibold text-gray-300">{{ site.port }}</span></p>
        <p class="mb-4">
            Status:
            {% if site.id in running_processes and running_processes[site.id].is_alive() %}
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-500 text-white"><i class="bi bi-check-circle-fill me-1"></i> Running</span>
            {% else %}
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-600 text-white"><i class="bi bi-x-circle-fill me-1"></i> Stopped</span>
            {% endif %}
        </p>
        <div class="mt-auto flex items-center gap-2">
            {% if site.id in running_processes and running_processes[site.id].is_alive() %}
                <a href="{{ url_for('stop_website', site_id=site.id) }}" class="btn btn-secondary bg-yellow-600 hover:bg-yellow-700 text-white text-sm">Stop</a>
            {% else %}
                <a href="{{ url_for('start_website', site_id=site.id) }}" class="btn btn-secondary bg-green-600 hover:bg-green-700 text-white text-sm">Start</a>
            {% endif %}
            <div class="relative inline-block text-left ms-auto">
                <button class="btn btn-secondary text-sm dropdown-toggle"><i class="bi bi-three-dots-vertical"></i></button>
                <div class="dropdown-menu origin-top-right absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-gray-800 ring-1 ring-black ring-opacity-5 z-20 hidden">
                    <div class="py-1" role="none">
                        <a href="{% if site.live_view_url %}{{ site.live_view_url }}{% else %}http://127.0.0.1:{{site.port}}{% endif %}" target="_blank" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700"><i class="bi bi-eye me-2"></i> View Live Site</a>
                        <a href="{{ url_for('live_edit', site_id=site.id) }}" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700"><i class="bi bi-magic me-2"></i> Modify index.html</a>
                        <div class="border-t border-gray-700 my-1"></div>
                        <a href="{{ url_for('manage_files', site_id=site.id) }}" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700"><i class="bi bi-folder me-2"></i> File Manager</a>
                        <button type="button" class="edit-site-btn block w-full text-left px-4 py-2 text-sm text-gray-300 hover:bg-gray-700" data-toggle="modal" data-target="#editSiteModal" data-site-id="{{ site.id }}" data-site-name="{{ site.name }}" data-site-port="{{ site.port }}" data-live-view-url="{{ site.live_view_url | default('') }}"><i class="bi bi-pencil-square me-2"></i> Edit Settings</button>
                        <button type="button" class="logs-btn block w-full text-left px-4 py-2 text-sm text-gray-300 hover:bg-gray-700" data-toggle="modal" data-target="#logsModal" data-site-id="{{ site.id }}" data-site-name="{{ site.name }}"><i class="bi bi-file-earmark-text me-2"></i> View Logs</button>
                        <div class="border-t border-gray-700 my-1"></div>
                        <a href="{{ url_for('backup_website', site_id=site.id) }}" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700"><i class="bi bi-cloud-download-fill me-2"></i> Download Backup (ZIP)</a>
                        <div class="border-t border-gray-700 my-1"></div>
                        <a href="{{ url_for('toggle_autostart', site_id=site.id) }}" class="block px-4 py-2 text-sm {% if site.autostart %}text-yellow-400{% else %}text-gray-400{% endif %} hover:bg-gray-700"><i class="bi bi-lightning-fill me-2"></i> AutoStart: {% if site.autostart %}On{% else %}Off{% endif %}</a>
                        <div class="border-t border-gray-700 my-1"></div>
                        <button type="button" class="delete-site-btn block w-full text-left px-4 py-2 text-sm text-red-400 hover:bg-red-500 hover:text-white" data-toggle="modal" data-target="#deleteSiteConfirmModal" data-site-id="{{ site.id }}" data-site-name="{{ site.name }}"><i class="bi bi-trash me-2"></i> Delete Website</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="md:col-span-2 lg:col-span-3 text-center py-16 px-6 bg-gray-900 border border-gray-800 rounded-lg">
        <h3 class="text-xl text-white">No websites yet!</h3>
        <p class="text-gray-400 mt-2">Use the "Create New Website" button to get started.</p>
    </div>
    {% endfor %}
</div>

<div class="modal" id="createSiteModal" tabindex="-1">
    <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title"><i class="bi bi-plus-circle me-2"></i> Create a New Website</h5><button type="button" class="btn-close" data-dismiss="modal">&times;</button></div>
        <form method="POST" action="{{ url_for('create_website') }}">
            {{ form.hidden_tag() }}
            <div class="modal-body space-y-4">
                <div><label class="block text-sm font-medium text-gray-400 mb-2">{{ form.name.label }}</label>{{ form.name(class="form-input", placeholder="My Awesome Blog") }}</div>
                <div><label class="block text-sm font-medium text-gray-400 mb-2">{{ form.port.label }}</label>{{ form.port(class="form-input") }}</div>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>{{ form.submit(class="btn btn-primary") }}</div>
        </form>
    </div>
</div>

<div class="modal" id="editSiteModal" tabindex="-1">
    <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title"><i class="bi bi-pencil-square me-2"></i> Edit Website Settings</h5><button type="button" class="btn-close" data-dismiss="modal">&times;</button></div>
        <form id="editSiteForm" method="POST" action="">
            <div class="modal-body space-y-4">
                <p class="text-gray-400 text-sm">Editing: <strong id="editingSiteName" class="text-white"></strong></p>
                <div><label for="edit_name" class="block text-sm font-medium text-gray-400 mb-2">Website Name</label><input type="text" id="edit_name" name="name" class="form-input" required></div>
                <div><label for="edit_port" class="block text-sm font-medium text-gray-400 mb-2">Port</label><input type="number" id="edit_port" name="port" class="form-input" required></div>
                <div><label for="edit_live_view_url" class="block text-sm font-medium text-gray-400 mb-2">Live View URL (Optional)</label><input type="url" id="edit_live_view_url" name="live_view_url" class="form-input" placeholder="https://example.com"><small class="text-gray-500 mt-1 block text-xs">Leave blank for default internal URL.</small></div>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button><button type="submit" class="btn btn-primary"><i class="bi bi-save me-1"></i> Update Website</button></div>
        </form>
    </div>
</div>

<div class="modal modal-sm" id="deleteSiteConfirmModal" tabindex="-1">
    <div class="modal-content">
        <div class="modal-header bg-dark-danger"><h5 class="modal-title text-base"><i class="bi bi-exclamation-triangle-fill me-2"></i> Confirm Deletion</h5><button type="button" class="btn-close" data-dismiss="modal">&times;</button></div>
        <form id="deleteSiteForm" method="POST" action="">
            <div class="modal-body text-center">
                <p class="text-gray-300">Delete <strong id="deleteSiteName" class="text-white"></strong>?</p>
                <p class="text-red-400 text-xs mt-2"><i class="bi bi-info-circle me-1"></i> This action is permanent.</p>
            </div>
            <div class="modal-footer justify-center"><button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button><button type="submit" class="btn btn-secondary bg-red-500 hover:bg-red-600 text-white"><i class="bi bi-trash me-1"></i> Delete Forever</button></div>
        </form>
    </div>
</div>

<div class="modal modal-lg" id="logsModal" tabindex="-1">
    <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title" id="logsModalLabel"><i class="bi bi-terminal-fill me-2"></i> Site Logs</h5><button type="button" class="btn-close" data-dismiss="modal">&times;</button></div>
        <div class="modal-body"><p class="text-gray-500 text-xs mb-3">Showing last 1000 lines from `logs.txt`.</p><div id="logContent" class="ansi-log-container">Loading logs...</div></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function () {
    // --- Custom Modal Logic ---
    const activeModals = {};
    function closeModal(modal) {
        if (modal) {
            modal.classList.remove('show');
            if (modal.id === 'logsModal' && logRefreshInterval) {
                clearInterval(logRefreshInterval);
                logRefreshInterval = null;
            }
            delete activeModals[modal.id];
        }
    }
    document.querySelectorAll('[data-toggle="modal"]').forEach(trigger => {
        trigger.addEventListener('click', function() {
            const targetId = this.dataset.target.substring(1);
            const modal = document.getElementById(targetId);
            if (modal) {
                modal.classList.add('show');
                activeModals[targetId] = modal;
            }
        });
    });
    document.querySelectorAll('[data-dismiss="modal"]').forEach(dismiss => {
        dismiss.addEventListener('click', function() { closeModal(this.closest('.modal')); });
    });
    window.addEventListener('click', event => {
        if (event.target.classList.contains('modal')) closeModal(event.target);
    });
    document.addEventListener('keydown', event => {
        if (event.key === "Escape") Object.values(activeModals).forEach(closeModal);
    });

    // --- Card Hover Effect ---
    document.querySelectorAll('.site-card').forEach(card => {
        card.addEventListener('mousemove', e => {
            const rect = card.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            card.style.setProperty('--mouse-x', `${x}px`);
            card.style.setProperty('--mouse-y', `${y}px`);
        });
    });

    // --- Original PWM Dashboard JS ---
    let logRefreshInterval = null;

    function ansiToHtml(text) {
        const ansiRegex = /\x1b\[([\d;]*)m/g;
        let html = '', lastIndex = 0, openTags = [];
        const codesMap = {'0':'reset','1':'ansi-bold','30':'ansi-black','31':'ansi-red','32':'ansi-green','33':'ansi-yellow','34':'ansi-blue','35':'ansi-magenta','36':'ansi-cyan','37':'ansi-white'};
        text.replace(ansiRegex, (match, ansiCode, offset) => {
            html += text.substring(lastIndex, offset);
            const codes = ansiCode.split(';').filter(c => c.length > 0);
            if (codes.length === 0) codes.push('0');
            codes.forEach(code => {
                if (code === '0') { while (openTags.length > 0) { html += '</span>'; openTags.pop(); } }
                else { const className = codesMap[code]; if (className) { html += `<span class="${className}">`; openTags.push(className); } }
            });
            lastIndex = offset + match.length;
        });
        html += text.substring(lastIndex);
        while (openTags.length > 0) { html += '</span>'; openTags.pop(); }
        return html;
    }

    function checkIfScrolledToBottom(el, tolerance = 10) { return el.scrollHeight - el.scrollTop - el.clientHeight <= tolerance; }

    async function loadLogs(siteId, logContentDiv, isInitialLoad = false) {
        if (!logContentDiv) return;
        try {
            const res = await fetch(`/website/logs/${siteId}`);
            const data = await res.json();
            if (data.status === 'success') {
                const rawText = data.logs.join('\n');
                const wasAtBottom = checkIfScrolledToBottom(logContentDiv);
                const currentScrollTop = logContentDiv.scrollTop;
                logContentDiv.innerHTML = ansiToHtml(rawText);
                if (isInitialLoad || wasAtBottom) { logContentDiv.scrollTop = logContentDiv.scrollHeight; }
                else { logContentDiv.scrollTop = currentScrollTop; }
            } else {
                logContentDiv.innerHTML = `<span class="ansi-red ansi-bold">${data.logs.join('\n') || data.message || 'Failed to load logs.'}</span>`;
                clearInterval(logRefreshInterval);
            }
        } catch (error) {
            logContentDiv.innerHTML = '<span class="ansi-red ansi-bold">Error connecting to log service.</span>';
            clearInterval(logRefreshInterval);
        }
    }

    document.querySelectorAll('.edit-site-btn').forEach(btn => btn.addEventListener('click', function() {
        const modal = document.getElementById('editSiteModal');
        modal.querySelector('#editSiteForm').action = `{{ url_for('edit_website', site_id=0) }}`.replace('0', this.dataset.siteId);
        modal.querySelector('#editingSiteName').textContent = this.dataset.siteName;
        modal.querySelector('#edit_name').value = this.dataset.siteName;
        modal.querySelector('#edit_port').value = this.dataset.sitePort;
        modal.querySelector('#edit_live_view_url').value = this.dataset.liveViewUrl;
    }));

    document.querySelectorAll('.delete-site-btn').forEach(btn => btn.addEventListener('click', function() {
        const modal = document.getElementById('deleteSiteConfirmModal');
        modal.querySelector('#deleteSiteForm').action = `{{ url_for('delete_website', site_id=0) }}`.replace('0', this.dataset.siteId);
        modal.querySelector('#deleteSiteName').textContent = this.dataset.siteName;
    }));

    document.querySelectorAll('.logs-btn').forEach(btn => btn.addEventListener('click', function() {
        const modal = document.getElementById('logsModal');
        modal.querySelector('.modal-title').textContent = `Site Logs for ${this.dataset.siteName}`;
        const logContentDiv = modal.querySelector('#logContent');
        logContentDiv.textContent = 'Fetching logs...';
        clearInterval(logRefreshInterval);
        loadLogs(this.dataset.siteId, logContentDiv, true);
        logRefreshInterval = setInterval(() => loadLogs(this.dataset.siteId, logContentDiv), 1000);
    }));
});
</script>
{% endblock %}
